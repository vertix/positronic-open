{% extends "base.html" %}

{% block title %}Episode {{ episode_id }} / {{ num_episodes }}{% endblock %}

{% block description %}Run explorer for the Physical AI Leaderboard. Browse individual evaluation runs on real robot
hardware.
{% endblock %}

{% block scripts %}
<script async>
    document.addEventListener('DOMContentLoaded', () => {
        initializeSidebar({{ static_data| tojson | safe }});
    });
</script>

<script>
    const episodeForm = document.getElementById('episode-form');
    const episodeInput = document.getElementById('episode-input');
    const maxEpisodes = {{ num_episodes }};

    const maxEpisodeLength = String(maxEpisodes - 1).length;
    episodeInput.style.width = `${maxEpisodeLength + 0.5}ch`;

    episodeForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const value = parseInt(episodeInput.value);
        if (isNaN(value) || value < 0 || value >= maxEpisodes) {
            episodeInput.value = episodeInput.dataset.original;
            return;
        }
        window.location.href = `/episode/${value}`;
    });

    episodeInput.addEventListener('blur', () => {
        const value = parseInt(episodeInput.value);
        if (isNaN(value) || value < 0 || value >= maxEpisodes) {
            episodeInput.value = episodeInput.dataset.original;
        }
    });

    episodeInput.addEventListener('focus', () => {
        episodeInput.select();
    });

    window.addEventListener('load', async () => {
        const loadingOverlay = document.getElementById('loading-overlay');
        const viewerIframe = document.getElementById('viewer-iframe');
        try {
            const rrdUrl = `${window.location.origin}/api/episode_rrd/{{ episode_id }}`;
            const viewerUrl = `/static/rerun/{{ rerun_version }}/index.html?url=${encodeURIComponent(rrdUrl)}`;
            viewerIframe.src = viewerUrl;
            viewerIframe.style.display = 'block';
            loadingOverlay.style.display = 'none';
        } catch (error) {
            console.error('Error loading episode:', error);
            loadingOverlay.innerHTML = `
                    <div style="text-align: center;">
                        <h2>Error loading episode</h2>
                        <p>${error.message}</p>
                        <br>
                        <a href="/" class="dataset-button" style="margin-top: 20px;">Back to Dataset</a>
                    </div>
                `;
        }
    });
</script>
{% endblock %}

{% block content %}
<main class="main main--full-screen">
    <div class="header">
        <div class="breadcrumbs">
            <a href="/" class="breadcrumb-link">{{ repo_id }}</a>
            <span class="breadcrumb-separator">›</span>
            <span class="breadcrumb-text">Ep. </span>
            <button onclick="window.location.href='/episode/{{ (episode_id - 1) % num_episodes }}'"
                class="nav-arrow-button" title="Previous episode">&lt;</button>
            <form id="episode-form" class="episode-form" style="display: inline; margin: 0;">
                <input type="text" id="episode-input" class="episode-input" value="{{ episode_id }}"
                    data-original="{{ episode_id }}" maxlength="{{ num_episodes|string|length }}">
            </form>
            <button onclick="window.location.href='/episode/{{ (episode_id + 1) % num_episodes }}'"
                class="nav-arrow-button" title="Next episode">&gt;</button>
            <span class="breadcrumb-text"> / {{ num_episodes }}</span>
            {% if task %}<span class="task-description"> : {{ task }}</span>{% endif %}
        </div>
    </div>
    <div class="episode-info-header">
        {% if episode_path or episode_size_mb %}
        <div class="episode-path">
            {% if episode_path %}
            <span class="episode-path-label">Episode path:</span>
            <code class="episode-path-value">{{ episode_path }}</code>
            {% endif %}
            {% if episode_size_mb %}
            <span class="episode-size">({{ episode_size_mb }} MB)</span>
            {% endif %}
        </div>
        {% endif %}

        <button class="sidebar-toggler">☰ Static Data</button>
    </div>
    <div class="episode-container">
        <div id="viewer-container">
            <div id="loading-overlay" class="loading-overlay">
                Loading Rerun viewer...
            </div>
            <iframe id="viewer-iframe" style="display: none;"></iframe>
        </div>
        <div class="sidebar">
            <div class="resizer sidebar-resizer"></div>
            <div class="resizer key-column-resizer"></div>
            <div class="sidebar-header">
                Dataset Info
            </div>
            <div class="sidebar-content">
                <div class="sidebar-content-wrapper"></div>
            </div>
        </div>
    </div>
</main>
{% endblock %}
