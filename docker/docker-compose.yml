services:
  positronic-training-base: &positronic-common
    image: positro/positronic:latest

    # Enable interactive terminal
    stdin_open: true
    tty: true

    # GPU support - requires nvidia-docker2 or Docker with NVIDIA Container Toolkit
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [compute, graphics, utility]

    # Volume mounts
    volumes:
      - ${CACHE_ROOT:-${HOME}}/.cache:/root/.cache
      - ${CACHE_ROOT:-${HOME}}/.aws:/root/.aws:ro
      - ${CACHE_ROOT:-${HOME}}/.local/share/uv:/root/.local/share/uv

    # Set HOME inside container to match the mount expectations
    environment:
      HOME: /root

    env_file:
      - path: .env.wandb
        required: false

    working_dir: /positronic

  positronic: &openpi-common
    image: positro/openpi:latest

    # Enable interactive terminal
    stdin_open: true
    tty: true

    # GPU support - requires nvidia-docker2 or Docker with NVIDIA Container Toolkit
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [compute, graphics, utility]

    # Volume mounts
    volumes:
      - ${CACHE_ROOT:-${HOME}}/.cache:/root/.cache
      - ${CACHE_ROOT:-${HOME}}/.aws:/root/.aws:ro
      - ${CACHE_ROOT:-${HOME}}/.local/share/uv:/root/.local/share/uv

    # Set HOME inside container to match the mount expectations
    environment:
      HOME: /root

    env_file:
      - path: .env.wandb
        required: false

    working_dir: /positronic
    ports:
      - "5000:5000"

  openpi-train:
    <<: *openpi-common
    container_name: openpi-train
    entrypoint: ["uv", "run", "--python", "3.11", "python", "-m", "positronic.vendors.openpi.train"]

  openpi-stats:
    <<: *openpi-common
    container_name: openpi-stats
    entrypoint: ["uv", "run", "--python", "3.11", "python", "-m", "positronic.vendors.openpi.stats"]

  positronic-to-lerobot:
    <<: *positronic-common
    container_name: positronic-to-lerobot
    entrypoint: ["uv", "run", "--python", "3.11", "positronic-to-lerobot"]

  lerobot-train:
    <<: *positronic-common
    container_name: lerobot-train
    entrypoint: ["uv", "run", "--python", "3.11", "positronic-train"]

  positronic-inference:
    <<: *positronic-common
    container_name: positronic-inference
    entrypoint: ["uv", "run", "--python", "3.11", "positronic-inference"]

    devices:
      - /dev/dri:/dev/dri

    environment:
      MUJOCO_GL: egl
      PYOPENGL_PLATFORM: egl

  positronic-server:
    <<: *positronic-common  # We need internal package for datasets
    container_name: positronic-server
    entrypoint: ["uv", "run", "--python", "3.11", "positronic-server"]
    ports:
      - "5000:5000"

  openpi-server: &openpi-server-common
    <<: *openpi-common
    container_name: openpi-server
    entrypoint: ["uv", "run", "--python", "3.11", "python", "-m", "positronic.vendors.openpi.server"]
    ports:
      - "8000:8000"

  openpi-server-8001:
    <<: *openpi-server-common
    ports:
      - "8001:8000"

  positronic-groot: &groot-common
    image: positro/gr00t:latest

    # Enable interactive terminal
    stdin_open: true
    tty: true

    # GPU support - requires nvidia-docker2 or Docker with NVIDIA Container Toolkit
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [compute, graphics, utility]

    # Volume mounts
    volumes:
      - ${CACHE_ROOT:-${HOME}}/.cache:/root/.cache
      - ${CACHE_ROOT:-${HOME}}/.aws:/root/.aws:ro
      - ${CACHE_ROOT:-${HOME}}/.local/share/uv:/root/.local/share/uv

    # Set HOME inside container to match the mount expectations
    environment:
      HOME: /root

    env_file:
      - path: .env.wandb
        required: false

    working_dir: /positronic

  groot-train:
    <<: *groot-common
    container_name: groot-train
    image: positro/gr00t:latest
    shm_size: 8g
    ipc: host  # Enable shared memory access for training
    entrypoint: ["uv", "run", "--python", "3.11", "python", "-m", "positronic.vendors.gr00t.train"]

  groot-server: &groot-server-common
    <<: *groot-common
    container_name: groot-server
    image: positro/gr00t:latest
    entrypoint: ["uv", "run", "--python", "3.11", "python", "-m", "positronic.vendors.gr00t.server"]
    ports:
      - "9000:9000"
